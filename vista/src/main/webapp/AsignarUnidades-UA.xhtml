<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>Asignar Unidades de Aprendizaje</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/primeicons@6.0.1/primeicons.css"/>

    <style>
        :root{
            --green: #2b9b45;
            --green-600: #238a3a;
            --text: #111;
            --card-bg: #ececec;
            --white: #fff;
            --muted: #dcdcdc;
        }

        *{ box-sizing: border-box; }
        html, body{ height: 100%; }
        body{
            margin: 0;
            font-family: "Kaisei Opti", serif;
            color: var(--text);
            background: #fff;
        }

        .layout {
            display: grid;
            grid-template-rows: auto 1fr; /* topbar + main */
            min-height: 100vh;
        }

        /* ======= TOPBAR ======= */
        .topbar {
            grid-column: 1 / span 2;
            grid-row: 1;
            display: flex;
            align-items: center;
            gap: 32px;
            background: var(--green);
            color: #0a0a0a;
            padding: 14px 24px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,.15);
        }
        .topbar .home{
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px; height: 28px;
            border-radius: 8px;
        }
        .topbar .menu{
            display: flex;
            align-items: center;
            gap: 28px;
            font-size: 22px;
            font-weight: 600;
        }
        .topbar .menu span{ cursor: default; }


        a.menu-btn,
        a.home-btn {
            appearance: none;
            -webkit-appearance: none;
            border: none;
            background-color: var(--green);
            font: inherit;
            line-height: 1;
            cursor: pointer;
            background: linear-gradient(to right, #3DAF94 50%, #111 50%);
            background-size: 200% 100%;
            background-position: right bottom;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: background-position 0.4s ease;
        }
        a.home-btn {
            font-size: 30px;
            padding: 6px 10px;
        }
        a.menu-btn:hover,
        a.home-btn:hover {
            background-position: left bottom;
        }
        /* ======= FIN TOPBAR ======= */

        .home i { font-size: 22px; }

        /* CONTENEDOR PARA EL FORMULARIO */
        .content{
            grid-row: 2;
            padding: 28px;
            display: flex;
            justify-content: center;
            align-items: stretch;
        }
        .card{
            width: min(1200px, 95%);
            background: var(--card-bg);
            border-radius: 12px;
            padding: 32px 28px;
            box-shadow: 0 2px 10px rgba(0,0,0,.08);
            flex: 1;
        }
        .title{
            margin: 0 0 18px 0;
            font-size: 26px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .title .pi { font-size: 20px; }

        /* DIVIDIR EN DOS LOS CONTENIDOS */
        .grid-asignacion{
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 28px;
        }

        /* PANEL FORMS */
        .panel{
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 1px 6px rgba(0,0,0,.08);
            padding: 18px;
        }
        .form-grid{
            display: grid;
            grid-template-columns: 1fr;
            gap: 14px;
        }
        .field{
            display: grid;
            gap: 6px;
        }
        .field label{
            font-weight: 700;
            font-size: 14px;
            color: #222;
        }

        /* HORAS RESTANTES */
        .info-row{
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-weight: 600;
            flex-wrap: wrap;
        }
        .info-pill{
            background: #fff;
            border: 1px solid var(--muted);
            border-radius: 10px;
            padding: 6px 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,.04);
        }
        .ok{ color: var(--green); }
        .warn{ color: #b00020; }

        /* BOTON DE AGREGAR */
        .btn-add{
            background: var(--green);
            color: #fff;
            font-weight: 700;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,.12);
            transition: transform .08s ease, background .2s ease;
        }
        .btn-add:hover{ background: var(--green-600); transform: translateY(-1px); }
        .btn-add[disabled]{ background: #9db8a4; cursor: not-allowed; transform: none; }

        /* HORARIO */
        .horario{
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 6px rgba(0,0,0,.08);
        }
        .horario thead th{
            background: var(--green);
            color: #fff;
            padding: 12px;
            text-align: center;
            font-weight: 700;
        }
        .horario td{
            border: 1px solid #e8e8e8;
            padding: 10px;
            vertical-align: top;
            text-align: left;
        }
        .horario-item{
            font-size: 13px;
            margin-bottom: 6px;
            display: flex;
            gap: 6px;
            align-items: center;
        }
        .chip{
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #f6f6f6;
            border: 1px solid #e3e3e3;
            border-radius: 999px;
            padding: 4px 8px;
        }
        .chip .pi{ font-size: 12px; }

        /* MENSAJES */
        #formAsignar\\:msgs{ margin-bottom: 10px; }

        /* FOCUS */
        .ui-inputfield:focus,
        .ui-inputtextarea:focus,
        .ui-selectonemenu:focus,
        .ui-spinner input:focus{
            border-color: var(--green) !important;
            box-shadow: 0 0 0 2px rgba(43,155,69,.15) !important;
        }

        /* Trigger select */
        .ui-selectonemenu .ui-selectonemenu-trigger{
            background: var(--green) !important;
            border-color: var(--green) !important;
        }
        .ui-selectonemenu .ui-selectonemenu-trigger:hover{
            background: var(--green-600) !important;
            border-color: var(--green-600) !important;
        }

        /* Spinner buttons */
        .ui-spinner-button{
            background: var(--green) !important;
            border-color: var(--green) !important;
            color: #fff !important;
        }
        .ui-spinner-button:hover{
            background: var(--green-600) !important;
            border-color: var(--green-600) !important;
        }

        /* Estados activos */
        .ui-state-active,
        .ui-widget-content .ui-state-active,
        .ui-widget-header .ui-state-active,
        .ui-paginator .ui-paginator-page.ui-state-active,
        .ui-tabs .ui-tabs-nav li.ui-tabs-selected a,
        .ui-datepicker .ui-datepicker-current-day a{
            background: var(--green) !important;
            border-color: var(--green) !important;
            color: #fff !important;
        }

        /* Mensajes éxito */
        .ui-messages-info,
        .ui-message-info{
            background: #e9f6ee !important;
            border: 1px solid var(--green) !important;
            color: var(--green) !important;
        }

        /* Botón agregar (primefaces) */
        .ui-button.btn-add,
        #formAsignar\:btnAdd.ui-button{
            background: var(--green) !important;
            border-color: var(--green) !important;
            color: #fff !important;
        }
        .ui-button.btn-add:hover,
        #formAsignar\:btnAdd.ui-button:hover,
        #formAsignar\:btnAdd.ui-button.ui-state-hover{
            background: var(--green-600) !important;
            border-color: var(--green-600) !important;
        }
        #formAsignar\:btnAdd.ui-button:focus{
            box-shadow: 0 0 0 2px rgba(43,155,69,.15) !important;
        }
        .ui-button.btn-add .ui-button-text,
        #formAsignar\:btnAdd .ui-button-text{ color:#fff !important; }
        .ui-button.btn-add .ui-icon,
        .ui-button.btn-add .pi,
        #formAsignar\:btnAdd .ui-icon,
        #formAsignar\:btnAdd .pi{ color:#fff !important; }
        .ui-button.btn-add:disabled,
        .ui-button.btn-add.ui-state-disabled,
        #formAsignar\:btnAdd.ui-button:disabled,
        #formAsignar\:btnAdd.ui-button.ui-state-disabled{
            background:#9db8a4 !important;
            border-color:#9db8a4 !important;
            color:#fff !important;
            opacity:1 !important;
        }
    </style>
</h:head>

<h:body>
    <h:form id="formAsignar">
        <div class="layout">

            <!-- TOPBAR -->
            <header class="topbar">
                <a href="Principal.xhtml" class="home-btn" aria-label="Inicio">
                    <span class="home"><i class="pi pi-home"></i></span>
                </a>
                <nav class="menu">
                    <a href="Profesores.xhtml" class="menu-btn">Profesores</a>
                    <a href="Principal-UDA.xhtml" class="menu-btn">Unidades de Aprendizaje</a>
                    <a href="AsignarUnidades-UA.xhtml" class="menu-btn">Asignar Unidades</a>
                    <a href="Consulta-CA.xhtml" class="menu-btn">Horarios</a>
                </nav>
            </header>

            <!-- CONTENIDO -->
            <main class="content">
                <section class="card">
                    <h2 class="title"><i class="pi pi-calendar-plus"></i>Asignación de Unidades</h2>

                    <!-- MENSAJES -->
                    <p:messages id="msgs"
                                showSummary="true"
                                showDetail="false"
                                closable="true"
                                autoUpdate="true" />

                    <div class="grid-asignacion">

                        <!-- PANEL DE LA SELECCION -->
                        <div class="panel">
                            <div class="form-grid">

                                <div class="field">
                                    <label><i class="pi pi-user"></i> Profesor</label>
                                    <p:selectOneMenu value="#{imparteBeanUI.profesorId}" style="width:100%" filter="true">
                                        <f:selectItem itemLabel="-- Selecciona profesor --" itemValue="#{null}" noSelectionOption="true"/>
                                        <f:selectItems value="#{imparteBeanUI.profesores}" var="p"
                                                       itemLabel="#{p.idProfesor} - #{p.nombre} #{p.apellidoPaterno}"
                                                       itemValue="#{p.idProfesor}"/>
                                        <p:ajax event="change"
                                                listener="#{imparteBeanUI.onProfesorChange}"
                                                update="tablaHorario panelRestantes finSpin btnAdd"/>
                                    </p:selectOneMenu>
                                </div>

                                <div class="field">
                                    <label><i class="pi pi-book"></i> Unidad</label>
                                    <p:selectOneMenu value="#{imparteBeanUI.unidadId}" style="width:100%" filter="true">
                                        <f:selectItem itemLabel="-- Selecciona unidad --" itemValue="#{null}" noSelectionOption="true"/>
                                        <f:selectItems value="#{imparteBeanUI.unidades}" var="u"
                                                       itemLabel="#{u.idUA} - #{u.nombre}"
                                                       itemValue="#{u.idUA}"/>
                                        <p:ajax event="change"
                                                listener="#{imparteBeanUI.recalcularDisponibles}"
                                                update="panelRestantes finSpin btnAdd"/>
                                    </p:selectOneMenu>
                                </div>

                                <div class="field">
                                    <label><i class="pi pi-tag"></i> Tipo</label>
                                    <p:selectOneMenu value="#{imparteBeanUI.tipo}" style="width:100%">
                                        <f:selectItems value="#{imparteBeanUI.tipos}" var="t"
                                                       itemLabel="#{t}" itemValue="#{t}"/>
                                        <p:ajax event="change"
                                                listener="#{imparteBeanUI.recalcularDisponibles}"
                                                update="panelRestantes finSpin btnAdd"/>
                                    </p:selectOneMenu>
                                </div>

                                <div class="field">
                                    <label><i class="pi pi-clock"></i> Día</label>
                                    <p:selectOneMenu value="#{imparteBeanUI.dia}" style="width:100%">
                                        <f:selectItems value="#{imparteBeanUI.dias}" var="d"
                                                       itemLabel="#{d}" itemValue="#{d}"/>
                                    </p:selectOneMenu>
                                </div>

                                <div class="field">
                                    <label><i class="pi pi-hourglass"></i> Hora inicio</label>
                                    <p:spinner id="iniSpin"
                                               value="#{imparteBeanUI.horaInicio}"
                                               min="0" max="23" step="1" suffix=":00">
                                        <p:ajax event="valueChange"
                                                listener="#{imparteBeanUI.recalcularDisponibles}"
                                                update="panelRestantes finSpin btnAdd"/>
                                    </p:spinner>
                                </div>

                                <div class="field">
                                    <label><i class="pi pi-hourglass-bottom"></i> Hora fin</label>
                                    <p:spinner id="finSpin"
                                               value="#{imparteBeanUI.horaFin}"
                                               min="#{imparteBeanUI.horaInicio + 1}"
                                               max="#{imparteBeanUI.maxHoraFin}"
                                               step="1" suffix=":00">
                                        <p:ajax event="valueChange" update="btnAdd"/>
                                    </p:spinner>
                                </div>

                                <!-- Info: horas restantes -->
                                <p:outputPanel id="panelRestantes" styleClass="info-row">
                                    <span class="info-pill">
                                        <i class="pi pi-info-circle"></i>
                                        <h:outputText value="Restan: "/>
                                        <h:outputText styleClass="#{imparteBeanUI.horasRestantes gt 0 ? 'ok' : 'warn'}"
                                                      value="#{imparteBeanUI.horasRestantes}"/>
                                        <h:outputText value=" h de #{imparteBeanUI.tipo} en la unidad seleccionada"/>
                                    </span>
                                    <h:panelGroup rendered="#{imparteBeanUI.horasRestantes le 0}">
                                        <span class="warn"><i class="pi pi-ban"></i> No hay horas disponibles para este tipo.</span>
                                    </h:panelGroup>
                                </p:outputPanel>

                                <p:commandButton id="btnAdd" value="Agregar clase" styleClass="btn-add"
                                                 icon="pi pi-plus"
                                                 actionListener="#{imparteBeanUI.agregarClase}"
                                                 update="msgs tablaHorario panelRestantes finSpin btnAdd"
                                                 disabled="#{imparteBeanUI.horasRestantes le 0 or (imparteBeanUI.horaFin - imparteBeanUI.horaInicio) gt imparteBeanUI.horasRestantes}"/>
                            </div>
                        </div>

                        <!-- HORARIO -->
                        <p:outputPanel id="tablaHorario">
                            <table class="horario">
                                <thead>
                                <tr>
                                    <th>Unidad</th>
                                    <th>Lunes</th>
                                    <th>Martes</th>
                                    <th>Miércoles</th>
                                    <th>Jueves</th>
                                    <th>Viernes</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td>
                                        <h:outputText value="#{imparteBeanUI.unidadId != null ?
                                        (imparteBeanUI.unidades.stream().filter(u -> u.idUA == imparteBeanUI.unidadId).findFirst().get().nombre) : '—'}"/>
                                    </td>
                                    <td>
                                        <ui:repeat value="#{imparteBeanUI.asignacionesDia('Lunes')}" var="a">
                                            <div class="horario-item">
                                                <span class="chip"><i class="pi pi-tag"></i>#{a.tipo}</span>
                                                <span><i class="pi pi-clock"></i> #{a.horaInicio}-#{a.horaFin}</span>
                                            </div>
                                        </ui:repeat>
                                    </td>
                                    <td>
                                        <ui:repeat value="#{imparteBeanUI.asignacionesDia('Martes')}" var="a">
                                            <div class="horario-item">
                                                <span class="chip"><i class="pi pi-tag"></i>#{a.tipo}</span>
                                                <span><i class="pi pi-clock"></i> #{a.horaInicio}-#{a.horaFin}</span>
                                            </div>
                                        </ui:repeat>
                                    </td>
                                    <td>
                                        <ui:repeat value="#{imparteBeanUI.asignacionesDia('Miercoles')}" var="a">
                                            <div class="horario-item">
                                                <span class="chip"><i class="pi pi-tag"></i>#{a.tipo}</span>
                                                <span><i class="pi pi-clock"></i> #{a.horaInicio}-#{a.horaFin}</span>
                                            </div>
                                        </ui:repeat>
                                    </td>
                                    <td>
                                        <ui:repeat value="#{imparteBeanUI.asignacionesDia('Jueves')}" var="a">
                                            <div class="horario-item">
                                                <span class="chip"><i class="pi pi-tag"></i>#{a.tipo}</span>
                                                <span><i class="pi pi-clock"></i> #{a.horaInicio}-#{a.horaFin}</span>
                                            </div>
                                        </ui:repeat>
                                    </td>
                                    <td>
                                        <ui:repeat value="#{imparteBeanUI.asignacionesDia('Viernes')}" var="a">
                                            <div class="horario-item">
                                                <span class="chip"><i class="pi pi-tag"></i>#{a.tipo}</span>
                                                <span><i class="pi pi-clock"></i> #{a.horaInicio}-#{a.horaFin}</span>
                                            </div>
                                        </ui:repeat>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </p:outputPanel>

                    </div>
                </section>
            </main>
        </div>
    </h:form>
</h:body>
</html>
